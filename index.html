<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Turnos rotativos - Empresa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            #print-area,
            #print-area * {
                visibility: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-extrabold">Turnos de la semana</h1>
                <p id="week-range" class="text-sm text-gray-600">Semana del ...</p>
            </div>

            <div class="flex gap-3 items-center flex-wrap">
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Ver semana:</label>
                    <input id="week-offset" type="number" value="0" min="0" max="520" class="w-24 p-2 rounded border"
                        title="0 = semana actual, 1 = siguiente semana, etc.">
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-600">Semanas a imprimir:</label>
                    <input id="print-weeks" type="number" value="1" min="1" max="12" class="w-20 p-2 rounded border">
                </div>

                <button id="print-btn"
                    class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">Imprimir /
                    Descargar</button>
            </div>
        </header>

        <section class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-center gap-4 flex-wrap">
                <div>
                    <input id="search" type="search" placeholder="Buscar persona..." class="p-2 rounded border w-56" />
                </div>
                <div class="text-sm text-gray-600">Contador al próximo cambio:</div>
                <div id="countdown" class="font-mono text-lg bg-white p-2 rounded shadow-sm"></div>
            </div>

            <div class="flex gap-3 flex-wrap">
                <button id="show-next-8" class="px-3 py-2 rounded border">Ver próximos 8 semanas</button>
                <button id="reset-view" class="px-3 py-2 rounded border">Volver a actual</button>
            </div>
        </section>

        <main>
            <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <hr class="my-6" />

            <details class="bg-white p-4 rounded shadow">
                <summary class="font-semibold cursor-pointer">Información y ayuda</summary>
                <div class="mt-3 text-sm text-gray-700">
                    <ul class="list-disc ml-5 space-y-1">
                        <li>Los turnos rotan automáticamente cada lunes. Base: lunes 20-10-2025.</li>
                        <li>Usa el selector "Ver semana" para ver turnos futuros (0 = semana actual).</li>
                        <li>El botón imprimir generará un PDF con la cantidad de semanas seleccionadas.</li>
                        <li>"Buscar" resalta la tarjeta de la persona y muestra un mini calendario de sus turnos.</li>
                    </ul>
                </div>
            </details>

            <div id="person-timeline" class="mt-6 bg-white p-4 rounded shadow hidden">
                <h3 class="font-semibold">Turnos próximos de <span id="timeline-name"></span></h3>
                <div id="timeline-list" class="mt-2 text-sm text-gray-700"></div>
            </div>

            <!-- printable area (cloned before print) -->
            <div id="print-area" class="hidden p-6"></div>
        </main>
    </div>


    <script>
        // --- Config / Base data ---
        const baseMonday = new Date('2025-10-20T00:00:00'); // base reference Monday
        const PEOPLE = [
            'María',
            'Daniel',
            'Jesús',
            'Judith',
            'Luis Badilla',
            'Jeremías',
            'Alexander',
            'Erika',
            'Hyun'
        ];

        // Colors for avatars
        const COLORS = ['#F97316', '#EF4444', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#06B6D4', '#84CC16'];

        // Utility: get monday for a date (local)
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = (day + 6) % 7; // days since monday
            date.setDate(date.getDate() - diff);
            date.setHours(0, 0, 0, 0);
            return date;
        }

        // weeks difference between target Monday and baseMonday
        function weeksSinceBase(monday) {
            const msPerWeek = 7 * 24 * 3600 * 1000;
            const diff = monday - getMonday(baseMonday);
            return Math.floor(diff / msPerWeek);
        }

        // Given week offset relative to current view, compute assignment
        // shift = number of weeks since baseMonday
        function assignmentForShift(shift) {
            // shift to the right: person moves to next turno each week
            // base: index 0 -> turn1
            const arr = new Array(9);
            for (let i = 0; i < 9; i++) {
                const newTurnIndex = (i + shift) % 9; // person at base turn (i) moves to turn newTurn
                arr[newTurnIndex] = PEOPLE[i];
            }
            return arr; // arr[0] = person who has turno1
        }

        // format date range for week
        function formatWeekRange(monday) {
            const end = new Date(monday);
            end.setDate(end.getDate() + 6);
            const opts = { day: '2-digit', month: 'short' };
            return `${monday.toLocaleDateString('es-CL', opts)} — ${end.toLocaleDateString('es-CL', opts)}`;
        }

        // deterministic color by name
        function colorFor(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = (hash << 5) - hash + name.charCodeAt(i);
            return COLORS[Math.abs(hash) % COLORS.length];
        }

        // initials
        function initials(name) {
            return name.split(' ').map(s => s[0] || '').slice(0, 2).join('').toUpperCase();
        }

        // Render grid for a specific monday (shift)
        function renderGridForMonday(monday, container = document.getElementById('grid')) {
            const shift = weeksSinceBase(monday);
            const assign = assignmentForShift((shift % 9 + 9) % 9);
            container.innerHTML = '';
            for (let i = 0; i < assign.length; i++) {
                const person = assign[i];
                const turno = i + 1;
                const card = document.createElement('article');
                card.className = 'bg-white p-4 rounded-lg shadow flex items-center gap-4 transform transition hover:scale-[1.01]';
                card.dataset.name = person.toLowerCase();
                card.innerHTML = `
          <div class="flex-shrink-0">
            <div class="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-lg" style="background:${colorFor(person)}">${initials(person)}</div>
          </div>
          <div class="flex-1">
            <div class="text-sm text-gray-500">Turno</div>
            <div class="flex items-center gap-3">
              <div class="text-2xl font-extrabold">${turno}</div>
              <div class="text-lg">${person}</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">${monday.toLocaleDateString('es-CL')}</div>
          </div>
        `;
                container.appendChild(card);
            }
        }

        // Calculate Monday date for 'n' weeks from current week (0 = current week)
        function mondayForViewOffset(viewOffset) {
            const today = new Date();
            const currentMonday = getMonday(today);
            const monday = new Date(currentMonday);
            monday.setDate(monday.getDate() + viewOffset * 7);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        // Countdown to next Monday 00:00 local
        function nextMondayCountdown() {
            const now = new Date();
            const currentMonday = getMonday(now);
            const nextMonday = new Date(currentMonday);
            nextMonday.setDate(nextMonday.getDate() + 7);
            nextMonday.setHours(0, 0, 0, 0);
            const diff = nextMonday - now;
            if (diff <= 0) return '0d 00:00:00';
            const d = Math.floor(diff / (24 * 3600 * 1000));
            const h = Math.floor((diff % (24 * 3600 * 1000)) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            return `${d}d ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // Show timeline for a person (next N weeks)
        function showPersonTimeline(name, weeks = 8) {
            const el = document.getElementById('person-timeline');
            const list = document.getElementById('timeline-list');
            document.getElementById('timeline-name').textContent = name;
            list.innerHTML = '';
            const todayMonday = getMonday(new Date());
            for (let w = 0; w < weeks; w++) {
                const mon = new Date(todayMonday);
                mon.setDate(mon.getDate() + w * 7);
                const shift = weeksSinceBase(mon);
                const assign = assignmentForShift((shift % 9 + 9) % 9);
                // find the turno for the person
                const idx = assign.findIndex(x => x.toLowerCase() === name.toLowerCase());
                const turnoText = idx >= 0 ? `Turno ${idx + 1}` : '—';
                const row = document.createElement('div');
                row.className = 'py-1 border-b last:border-b-0';
                row.innerHTML = `<strong>${mon.toLocaleDateString('es-CL')}</strong> — ${turnoText}`;
                list.appendChild(row);
            }
            el.classList.remove('hidden');
            el.scrollIntoView({ behavior: 'smooth' });
        }

        // Prepare printable content for N weeks starting at given monday
        function preparePrint(mondayStart, weeksToPrint) {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';
            for (let w = 0; w < weeksToPrint; w++) {
                const mon = new Date(mondayStart);
                mon.setDate(mon.getDate() + 7 * w);
                const shift = weeksSinceBase(mon);
                const assign = assignmentForShift((shift % 9 + 9) % 9);

                const block = document.createElement('section');
                block.className = 'mb-6';
                const title = document.createElement('h2');
                title.className = 'text-xl font-bold mb-3';
                title.textContent = `Semana: ${formatWeekRange(mon)} (lunes ${mon.toLocaleDateString('es-CL')})`;
                block.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-3 gap-3';
                for (let i = 0; i < assign.length; i++) {
                    const person = assign[i];
                    const turno = i + 1;
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded';
                    card.innerHTML = `<div class="font-bold">Turno ${turno}</div><div>${person}</div>`;
                    grid.appendChild(card);
                }
                block.appendChild(grid);
                printArea.appendChild(block);
            }
            // show print area
            printArea.classList.remove('hidden');
        }

        // Initial render
        const gridEl = document.getElementById('grid');
        const weekRangeEl = document.getElementById('week-range');
        const weekOffsetInput = document.getElementById('week-offset');
        const printWeeksInput = document.getElementById('print-weeks');

        function updateView() {
            const offset = parseInt(weekOffsetInput.value, 10) || 0;
            const monday = mondayForViewOffset(offset);
            renderGridForMonday(monday, gridEl);
            weekRangeEl.textContent = `Semana del ${formatWeekRange(monday)}`;
        }

        // update countdown every second
        const countdownEl = document.getElementById('countdown');
        setInterval(() => {
            countdownEl.textContent = nextMondayCountdown();
        }, 1000);

        // Search behavior
        document.getElementById('search').addEventListener('input', (e) => {
            const q = e.target.value.trim().toLowerCase();
            const cards = gridEl.querySelectorAll('[data-name]');
            let found = false;
            cards.forEach(c => {
                if (!q) { c.classList.remove('ring-4', 'ring-indigo-200'); c.style.opacity = ''; }
                else if (c.dataset.name.includes(q)) { c.classList.add('ring-4', 'ring-indigo-200'); c.style.opacity = '1'; found = true; }
                else { c.classList.remove('ring-4', 'ring-indigo-200'); c.style.opacity = '0.4'; }
            });
            if (found) {
                // show timeline for first match
                const match = Array.from(cards).find(c => c.dataset.name.includes(q));
                if (match) showPersonTimeline(match.dataset.name, 8);
            } else {
                document.getElementById('person-timeline').classList.add('hidden');
            }
        });

        // click on a card to show timeline
        gridEl.addEventListener('click', (e) => {
            let card = e.target.closest('[data-name]');
            if (!card) return;
            showPersonTimeline(card.dataset.name, 12);
        });

        // print handler
        document.getElementById('print-btn').addEventListener('click', () => {
            const offset = parseInt(weekOffsetInput.value, 10) || 0;
            const weeksToPrint = parseInt(printWeeksInput.value, 10) || 1;
            const monday = mondayForViewOffset(offset);
            preparePrint(monday, weeksToPrint);
            setTimeout(() => window.print(), 150);
        });

        // quick controls
        document.getElementById('show-next-8').addEventListener('click', () => { weekOffsetInput.value = 1; updateView(); });
        document.getElementById('reset-view').addEventListener('click', () => { weekOffsetInput.value = 0; updateView(); });

        // bootstrap: sync inputs and view
        weekOffsetInput.addEventListener('change', updateView);
        weekOffsetInput.addEventListener('input', updateView);

        // On load compute alignment to baseMonday so that week 0 corresponds to actual current week
        // But user provided base Monday date assignments for 2025-10-20; weeksSinceBase handles that.
        updateView();

    </script>
</body>

</html>