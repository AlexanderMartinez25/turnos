---
import BaseLayout from "../components/layouts/BaseLayout.astro";

import { resolveWeek } from "../domain/resolveWeek";
import { getTodayDay } from "../utils/today";
import { formatDayLabel } from "../utils/formatDate";

/**
 * Día actual
 */
const todayKey = getTodayDay();
const today = new Date();

/**
 * Resolver semana
 */
const weekData = resolveWeek(today);

/**
 * Separar activos y libres
 */
const activos = [];
const libres = [];

for (const emp of weekData) {
  const d = emp.dias[todayKey];

  if (d?.trabaja) {
    activos.push({
      nombre: emp.empleado,
      turno: emp.turno,
      ...d,
    });
  } else {
    libres.push({
      nombre: emp.empleado,
      turno: emp.turno,
    });
  }
}

/**
 * Label fecha
 */
const dayLabel = formatDayLabel(today, todayKey);
---

<BaseLayout title="Dashboard">
  <main class="min-h-screen bg-base text-slate-100 p-6">
    <!-- Header -->
    <header class="mb-10 text-center">
      <h1 class="text-3xl font-semibold">
        Turnos de Hoy
      </h1>
      <p class="text-lg text-accent mt-1">
        {dayLabel}
      </p>
    </header>

    <!-- ACTIVOS -->
    <section>
      <h2 class="text-xl font-semibold mb-4">
        En turno
      </h2>

      {activos.length === 0 ? (
        <div class="text-center text-xl text-slate-400">
          No hay personal en turno
        </div>
      ) : (
        <div class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
          {activos.map((item) => (
            <article class="bg-surface rounded-xl p-6 border border-slate-800 flex flex-col justify-between">
              <!-- Header card -->
              <div class="flex justify-between items-start">
                <h3 class="text-xl font-medium">
                  {item.nombre}
                </h3>

                <!-- TURNO destacado -->
                <span class="text-lg font-semibold px-3 py-1 rounded-lg bg-accent text-base">
                  T{item.turno}
                </span>
              </div>

              <!-- Horario -->
              <div class="mt-4">
                <p class="text-lg">
                  {item.entrada} – {item.salida}
                </p>

                {item.flags?.includes("LATE_ENTRY") && (
                  <p class="text-sm text-yellow-400 mt-1">
                    Entrada tardía
                  </p>
                )}

                {item.flags?.includes("EARLY_EXIT") && (
                  <p class="text-sm text-cyan-400 mt-1">
                    Sale a las 17:00
                  </p>
                )}
              </div>

              <!-- Edificio -->
              <div class="mt-6">
                {item.edificio ? (
                  <span class="inline-block text-base font-bold px-4 py-2 rounded-full bg-slate-300">
                    {item.edificio}
                  </span>
                ) : (
                  <span class="text-sm text-slate-500">
                    Sin asignación
                  </span>
                )}
              </div>
            </article>
          ))}
        </div>
      )}
    </section>

    <!-- LIBRES -->
    <section class="mt-12">
      <h2 class="text-xl font-semibold mb-4 text-slate-300">
        Libres hoy
      </h2>

      {libres.length === 0 ? (
        <p class="text-slate-500">
          No hay personal libre hoy.
        </p>
      ) : (
        <div class="grid gap-4 grid-cols-2 sm:grid-cols-3 lg:grid-cols-4">
          {libres.map((item) => (
            <div class="bg-slate-900/40 border border-slate-800 rounded-lg p-4 text-center">
              <p class="font-medium text-slate-300">
                {item.nombre}
              </p>
              <p class="text-xs text-slate-500 mt-1">
                Turno {item.turno}
              </p>
            </div>
          ))}
        </div>
      )}
    </section>
  </main>
</BaseLayout>
