---
import BaseLayout from "../components/layouts/BaseLayout.astro";
import AppLayout from "../components/layouts/AppLayout.astro";

import { resolveWeek } from "../domain/resolveWeek";
import { getTodayDay } from "../utils/today";
import { formatDayLabel } from "../utils/formatDate";

/**
 * Día actual (key sin acento)
 */
const todayKey = getTodayDay();

/**
 * Resolver semana actual
 */
const today = new Date();
const weekData = resolveWeek(today);

/**
 * Agenda de hoy (solo quienes trabajan)
 */
const agenda = weekData
  .map((emp) => {
    const d = emp.dias[todayKey];
    return d
      ? {
          nombre: emp.empleado,
          turno: emp.turno,
          ...d,
        }
      : null;
  })
  .filter((item) => item && item.trabaja);

/**
 * Label de fecha (ej: Martes · 14 Ene)
 */
const dayLabel = formatDayLabel(today, todayKey);
---

<BaseLayout title="Hoy">
  <AppLayout>
    <!-- Header -->
    <header class="mb-4">
      <h1 class="text-xl font-semibold text-slate-100">
        Hoy
      </h1>
      <p class="text-sm text-accent">
        {dayLabel}
      </p>
    </header>

    <!-- Agenda -->
    <section class="space-y-3">
      {agenda.length === 0 && (
        <div class="rounded-lg border border-dashed border-slate-700 p-4 text-sm text-slate-400">
          Hoy no hay empleados trabajando.
        </div>
      )}

<ul class="grid grid-cols-2 gap-3 animate-fade-in">
        {agenda.map((item, index) => (
          <li style={`animation-delay: ${index * 30}ms; animation-fill-mode: both;`} class="relative bg-gradient-to-br from-surface/40 via-surface/30 to-surface/20 backdrop-blur-2xl rounded-2xl p-4 border border-white/20 shadow-2xl shadow-black/30 before:absolute before:inset-0 before:rounded-2xl before:bg-gradient-to-tr before:from-white/10 before:via-transparent before:to-transparent before:opacity-50 before:pointer-events-none">
            <div class="flex justify-between items-start gap-3">
              <!-- Info principal -->
              <div>
                <p class="font-medium">
                  {item.nombre}
                </p>

                <p class="text-xs text-slate-400 mt-1">
                  {item.entrada} – {item.salida}
                </p>

                <!-- Flags -->
                {item.flags?.length > 0 && (
                  <div class="flex gap-1 mt-1">
                    {item.flags.includes("LATE_ENTRY") && (
                      <span class="text-[10px] px-2 py-0.5 rounded bg-yellow-500/10 text-yellow-400">
                        Entrada tardía
                      </span>
                    )}
                    {item.flags.includes("EARLY_EXIT") && (
                      <span class="text-[10px] px-2 py-0.5 rounded bg-cyan-500/10 text-cyan-400">
                        Sale 17:00
                      </span>
                    )}
                  </div>
                )}
              </div>

              <!-- Info secundaria -->
              <div class="text-right ">
                {item.edificio && (
                <span class="text-xs px-2 py-1 rounded-full bg-gradient-to-r from-surface/60 to-surface/40 backdrop-blur-md border border-white/20 text-slate-300 shadow-lg ">
                    {item.edificio}
                  </span>
                )}

                <span class="inline-block text-xs px-2 py-1 rounded-full bg-gradient-to-r from-accent/40 to-accent/20 backdrop-blur-md border border-accent/50 text-accent font-semibold mt-1 shadow-lg">
                  Turno {item.turno}
                </span>
              </div>
            </div>
          </li>
        ))}
      </ul>
    </section>
  </AppLayout>
</BaseLayout>
